<div class="application" *ngIf="map$ | async as map" #agmMap>
    <agm-map
      (mapReady)="mapReady($event)"
      class="application__map"
      [zoom]="16"
      minZoom="16"
      maxZoom="16"
      [scrollwheel]="false"
      [disableDefaultUI]="true"
      [styles]="styles"
      [restriction]="{latLngBounds: {north: map.lat + .05, south: map.lat - .05, west: map.lng -.05, east: map.lng + .05}}"
    >
        <agm-marker
          [latitude]="map.lat"
          [longitude]="map.lng"
        ></agm-marker>

        <ng-container *ngIf="contacts$ | async as contacts">

            <agm-polygon
              *ngFor="let contract of contacts;let i = index; trackBy: trackByFn"
              [strokeColor]="i === 0 ? 'rgba(255,255,255,.16)' : 'rgba(255,255,255,.4)'"
              [fillColor]="i === 0 ? 'rgba(0,0,0,0)' : 'rgba(27,34,52,.1)'"
              [paths]="contract.point | hexagon"
            >
                <agm-overlay
                  *ngIf="contract.warning"
                  [latitude]  = "contract.point.lat"
                  [longitude] = "contract.point.lng"
                >
                  <!-- blue html square -->
                  <div class="hexagon-bg">
                    <svg *ngIf="contract.warning === 'police'" xmlns="http://www.w3.org/2000/svg" width="108" height="126" fill="none">
                      <path d="M54 3l52 30v60l-52 30L2 93V33L54 3z" fill="#259AE4" fill-opacity=".12" stroke="#259AE4" stroke-width="4"/>
                      <path d="M51.72 52.147L40.427 71a2.667 2.667 0 002.28 4h22.586a2.666 2.666 0 002.28-4L56.28 52.147a2.667 2.667 0 00-4.56 0v0zM54 59v5.333M54 69.667h.013" stroke="#259AE4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <svg *ngIf="contract.warning === 'fire'" xmlns="http://www.w3.org/2000/svg" width="108" height="126" fill="none">
                      <path d="M54 3l52 30v60l-52 30L2 93V33L54 3z" fill="#F2A616" fill-opacity=".12" stroke="#F2A616" stroke-width="4"/>
                      <path d="M61.55 61.997a8.144 8.144 0 00-1.944-2.7l-.682-.626a.189.189 0 00-.304.078l-.305.874c-.19.548-.54 1.108-1.034 1.66a.146.146 0 01-.096.046.13.13 0 01-.1-.035.138.138 0 01-.047-.113c.086-1.41-.336-3.002-1.26-4.734-.763-1.44-1.825-2.562-3.151-3.345l-.968-.57a.188.188 0 00-.282.172l.052 1.125c.035.769-.054 1.448-.265 2.013a6.687 6.687 0 01-1.102 1.91c-.329.401-.702.764-1.113 1.08a8.265 8.265 0 00-2.35 2.849 8.15 8.15 0 00-.2 6.803 8.235 8.235 0 004.392 4.35 8.246 8.246 0 003.209.643 8.286 8.286 0 003.209-.64 8.17 8.17 0 002.622-1.751 8.114 8.114 0 002.419-5.787 8.067 8.067 0 00-.7-3.302z" fill="#F2A616"/>
                    </svg>
                    <svg *ngIf="contract.warning === 'emergency'"  xmlns="http://www.w3.org/2000/svg" width="108" height="126" fill="none">
                      <path d="M54 3l52 30v60l-52 30L2 93V33L54 3z" fill="#E33B3C" fill-opacity=".12" stroke="#E33B3C" stroke-width="4"/>
                      <g clip-path="url(#clip0)" fill="#E33B3C">
                        <path d="M51 51h6v24h-6z"/>
                        <path d="M66 60v6H42v-6z"/>
                      </g>
                      <defs>
                        <clipPath id="clip0">
                          <path fill="#fff" transform="translate(42 51)" d="M0 0h24v24H0z"/>
                        </clipPath>
                      </defs>
                    </svg>
                  </div>
                </agm-overlay>
            </agm-polygon>
        </ng-container>
    </agm-map>

    <div class="application__info">
      <div>
        Map coords: {{ map.lat}} , {{ map.lng }}
      </div>
      <div class="application__info-speed">
        Speed: {{ speed$ | async | number:'1.1-1' }} km/h
      </div>
      <div class="application__info-movement">
        Movement: {{ movement$ | async }}
      </div>
      <div class="application__info-direction">
        Direction: {{direction$ | async | json }}
      </div>
    </div>

    <div class="application__actions">
      <button class="application__actions-btn" (click)="createEmergencySituation('protocol-emergency')" mat-button mat-raised-button color="warn">Emergency situation</button>
      <button class="application__actions-btn" (click)="createEmergencySituation('protocol-fire')" mat-button mat-raised-button color="warn">Fire</button>
      <button class="application__actions-btn" (click)="createEmergencySituation('protocol-police')" mat-button mat-raised-button color="warn">Robbery</button>
    </div>

    <div class="application__control" id="joystick-main">
      <div #joystickNode class="joystick-base"></div>
    </div>

    <div class="application__certificates">
        <a class="application__actions-btn" [routerLink]="constants.routes.listing | route" mat-button mat-raised-button color="warn">Get a certificate</a>
    </div>
</div>
